# TravelEngine — Architecture Summary

## Purpose
TravelEngine schedules and hydrates per-route jobs (e.g., for fare or rewards data). It provides an admin UI to manage routes, providers, and per-route configuration and jobs.

## High-level components
- Laravel (v12) application with Livewire (v3) UI components.
- Core domain: Routes, Providers, and Jobs.
- Background synchronization command that maintains `route_jobs` (create/archive/rehydrate).

## Data model
- `routes` (table)
  - `id` (uuid, primary)
  - `ori`, `dst` (3-character IATA codes)
  - Relations: `configs` (routes_config), `jobs` (route_jobs)

- `routes_config` (table)
  - Per-route key/value config rows (e.g. `days_ahead`, `days_hydrate`)

- `route_jobs` (table)
  - `id` (auto-increment)
  - `route_id` (uuid FK → `routes.id`)
  - `job_date` (date)
  - `status` (pending, running, success, failed, archived)
  - `archived` (boolean)
  - `next_run_at`, `last_hydrated_at` (timestamps)
  - Unique constraint: (`route_id`, `job_date`)

- `providers` (table)
  - `code` (string PK, e.g. `VA`) and attributes `name`, `country`, `active`
  - `provider_configs` stores provider-specific key/value pairs

## Key models (files)
- `App\Models\Route` — `configs()` and `jobs()` relations, helper configValue(), daysAhead(), daysHydrate().
- `App\Models\RouteConfig` — maps to `routes_config` table.
- `App\Models\RouteJob` — tracks job lifecycle and casts (dates, timestamps); scope `active()`.
- `App\Models\Provider`, `App\Models\ProviderConfig` — provider data + configs.

## Livewire UI managers (CRUD + views)
- `RoutesManager` → `resources/views/livewire/routes-manager.blade.php`
- `RouteConfigManager` → `resources/views/livewire/route-config-manager.blade.php`
- `RouteJobsManager` → `resources/views/livewire/route-jobs-manager.blade.php`
- `ProviderManager` → `resources/views/livewire/provider-manager.blade.php`
- `ProviderConfigManager` → `resources/views/livewire/provider-config-manager.blade.php`

These components handle create/read/update/delete for their respective domain models and are embedded in admin views under `resources/views/admin`.

## Background / Scheduling
- `App\Console\Commands\SyncRouteJobs` (`routes:sync-jobs`) —
  - Archives past jobs
  - Creates future jobs using each route's `days_ahead` config
  - Re-opens (rehydrates) successful jobs inside the `days_hydrate` window
- Scheduled in `App\Console\Kernel::schedule()` to run daily at `02:00` (can be changed to hourly).

Notes for workers:
- Jobs are not queued via Laravel queue in this repo; `route_jobs` is an internal table used by a worker or external hydrator to process each `route_job` record.
- `route_jobs.status` and `next_run_at` fields allow workers to pick and run jobs.

## Views & Routes
- Frontend admin pages live under `resources/views/admin` and use the Livewire managers.
- Routes are defined in `routes/web.php` with admin prefixed pages and a route details page using implicit model binding for `Route` (UUID).

## Development & Runtime (quickstart)
These instructions assume Windows PowerShell (repository root: `c:\Code\travelengine`).

1. Install PHP deps

```powershell
composer install
```

2. Create `.env` and app key

```powershell
copy .env.example .env
php artisan key:generate
```

3. Local SQLite (quick, recommended for dev)

```powershell
mkdir database
New-Item -Path database\database.sqlite -ItemType File -Force
# Edit .env: set DB_CONNECTION=sqlite and DB_DATABASE=database/database.sqlite
```

4. Ensure writable directories (Windows example)

```powershell
icacls ".\bootstrap\cache" /grant "Everyone:(F)"
icacls ".\storage" /grant "Everyone:(F)"
```

5. Run migrations

```powershell
php artisan migrate
```

6. Install frontend deps & dev server

```powershell
npm install
npm run dev
```

7. Run the app

```powershell
php artisan serve
```

8. Scheduler (development)
- On Windows, either run the scheduler worker in a terminal while developing:

```powershell
php artisan schedule:work
```

- Or emulate daily runs manually for testing:

```powershell
php artisan routes:sync-jobs
```

## Testing
- PHPUnit config uses in-memory SQLite. Run:

```powershell
composer test
# or
php artisan test
```

## Next steps & suggestions
- Add a worker that picks `route_jobs` with `status = pending` and `next_run_at <= now()` then sets `running` / `success` / `failed` and updates `last_hydrated_at` on success.
- Consider queue-based processing for parallelism and reliability.
- Add seeders or demo data for quicker local development.
- Add short diagrams (ERD) to `documentation/` for onboarding.

---
Generated by an automated repository scan — review for accuracy and expand with examples or diagrams as needed.
